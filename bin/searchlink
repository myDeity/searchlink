#!/usr/bin/env ruby
# encoding: utf-8

SILENT = ENV['SL_SILENT'] =~ /false/i ? false : true
$LOAD_PATH.unshift File.join(__dir__, '..')

# import
require 'lib/searchlink'

if RUBY_VERSION.to_f > 1.9
  Encoding.default_external = Encoding::UTF_8
  Encoding.default_internal = Encoding::UTF_8
end

# GIST_CACHE = SL::Util.cache_file_for('gist')

sl = SL::SearchLink.new({ echo: true })
SL::Searches.load_custom

# # ignore
# SL::Searches.load_searches

overwrite = true
backup = SL.config['backup']

if !ARGV.empty?
  files = []
  ARGV.each do |arg|
    case arg
    when /^(--?)?h(elp)?$/
      print SL.version_check
      puts
      sl.help_cli
      $stdout.puts 'See https://github.com/ttscoff/searchlink/wiki for help'
      Process.exit
    when /^(--?)?v(er(s(ion)?)?)?$/
      print SL.version_check
    when /^--?(stdout)$/
      overwrite = false
    when /^--?no[\-_]backup$/
      backup = false
    else
      files.push(arg)
    end
  end

  files.each do |file|
    if File.exist?(file) && `file -b "#{file}"|grep -c text`.to_i.positive?
      input = RUBY_VERSION.to_f > 1.9 ? IO.read(file).force_encoding('utf-8') : IO.read(file)

      FileUtils.cp(file, "#{file}.bak") if backup && overwrite

      sl.parse(input)

      if overwrite
        File.open(file, 'w') do |f|
          f.puts sl.output
        end
      else
        puts sl.output
      end
    else
      warn "Error reading #{file}"
    end
  end
else
  input = RUBY_VERSION.to_f > 1.9 ? $stdin.read.force_encoding('utf-8').encode : $stdin.read

  sl.parse(input)
  if sl.clipboard
    print input
  else
    print sl.output
  end
end
